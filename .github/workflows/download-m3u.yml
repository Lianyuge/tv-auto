name: Advanced M3U Parser

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 00:00
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  process-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Download and parse M3U
      run: |
        # ä¸‹è½½M3Uæ–‡ä»¶
        curl -s -o jackTV.m3u "https://php.946985.filegear-sg.me/jackTV.m3u"
        
        # Pythonè„šæœ¬è§£æM3U
        python3 << 'EOF'
        from datetime import datetime
        import re
        
        # è¯»å–M3Uæ–‡ä»¶
        with open('jackTV.m3u', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # è§£æé¢‘é“
        channels = []
        lines = content.split('\n')
        i = 0
        while i < len(lines):
            line = lines[i].strip()
            if line.startswith('#EXTINF:'):
                # æå–é¢‘é“ä¿¡æ¯
                extinf = line
                i += 1
                if i < len(lines):
                    url = lines[i].strip()
                    
                    # ä»EXTINFæå–é¢‘é“å
                    # æ ¼å¼ç¤ºä¾‹: #EXTINF:-1 tvg-id="" tvg-name="CCTV1" tvg-logo="" group-title="å¤®è§†",CCTV1
                    match = re.search(r'tvg-name="([^"]+)"', extinf)
                    tvg_name = match.group(1) if match else ""
                    
                    match = re.search(r'group-title="([^"]+)"', extinf)
                    group = match.group(1) if match else "æœªåˆ†ç±»"
                    
                    match = re.search(r',([^,]+)$', extinf)
                    channel_name = match.group(1) if match else "æœªçŸ¥é¢‘é“"
                    
                    channels.append({
                        'name': channel_name,
                        'tvg_name': tvg_name,
                        'group': group,
                        'url': url,
                        'extinf': extinf
                    })
            i += 1
        
        # æŒ‰åˆ†ç»„æ•´ç†
        groups = {}
        for channel in channels:
            group = channel['group']
            if group not in groups:
                groups[group] = []
            groups[channel['group']].append(channel)
        
        # ç”ŸæˆHTML
        html = f'''<!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>JackTV é¢‘é“åˆ—è¡¨</title>
            <style>
                :root {{
                    --primary-color: #4a6fa5;
                    --secondary-color: #166088;
                    --background-color: #f8f9fa;
                }}
                * {{
                    box-sizing: border-box;
                }}
                body {{
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: var(--background-color);
                    color: #333;
                    line-height: 1.6;
                    padding: 20px;
                    max-width: 1400px;
                    margin: 0 auto;
                }}
                .header {{
                    text-align: center;
                    padding: 30px 0;
                    margin-bottom: 30px;
                }}
                .header h1 {{
                    color: var(--primary-color);
                    font-size: 2.5em;
                    margin-bottom: 10px;
                }}
                .stats {{
                    display: flex;
                    justify-content: center;
                    gap: 30px;
                    margin: 20px 0;
                    flex-wrap: wrap;
                }}
                .stat-card {{
                    background: white;
                    padding: 15px 25px;
                    border-radius: 10px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    text-align: center;
                    min-width: 150px;
                }}
                .stat-number {{
                    font-size: 2em;
                    font-weight: bold;
                    color: var(--secondary-color);
                }}
                .groups {{
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                    gap: 20px;
                    margin-top: 30px;
                }}
                .group-card {{
                    background: white;
                    border-radius: 10px;
                    overflow: hidden;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    transition: transform 0.3s ease;
                }}
                .group-card:hover {{
                    transform: translateY(-5px);
                }}
                .group-header {{
                    background: var(--primary-color);
                    color: white;
                    padding: 15px 20px;
                    font-size: 1.2em;
                    font-weight: bold;
                }}
                .channel-list {{
                    padding: 15px;
                    max-height: 400px;
                    overflow-y: auto;
                }}
                .channel-item {{
                    padding: 10px;
                    border-bottom: 1px solid #eee;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }}
                .channel-item:last-child {{
                    border-bottom: none;
                }}
                .channel-name {{
                    font-weight: 500;
                }}
                .play-btn {{
                    background: var(--secondary-color);
                    color: white;
                    border: none;
                    padding: 5px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    text-decoration: none;
                    font-size: 0.9em;
                    display: inline-block;
                }}
                .play-btn:hover {{
                    opacity: 0.9;
                }}
                .update-time {{
                    text-align: center;
                    margin-top: 40px;
                    color: #666;
                    font-size: 0.9em;
                }}
                .actions {{
                    text-align: center;
                    margin: 30px 0;
                }}
                .download-btn {{
                    display: inline-block;
                    background: #28a745;
                    color: white;
                    padding: 12px 30px;
                    border-radius: 5px;
                    text-decoration: none;
                    font-weight: bold;
                    margin: 0 10px;
                }}
                .raw-btn {{
                    display: inline-block;
                    background: #6c757d;
                    color: white;
                    padding: 12px 30px;
                    border-radius: 5px;
                    text-decoration: none;
                    font-weight: bold;
                    margin: 0 10px;
                }}
                @media (max-width: 768px) {{
                    .groups {{
                        grid-template-columns: 1fr;
                    }}
                    .stats {{
                        flex-direction: column;
                        align-items: center;
                    }}
                }}
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸ“º JackTV ç›´æ’­æº</h1>
                <p>è‡ªåŠ¨æ›´æ–°çš„IPTVé¢‘é“åˆ—è¡¨</p>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number">{len(channels)}</div>
                    <div>æ€»é¢‘é“æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{len(groups)}</div>
                    <div>åˆ†ç»„æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{datetime.now().strftime('%m-%d')}</div>
                    <div>æ›´æ–°æ—¥æœŸ</div>
                </div>
            </div>
            
            <div class="actions">
                <a href="jackTV.m3u" class="download-btn" download>ğŸ“¥ ä¸‹è½½M3Uæ–‡ä»¶</a>
                <a href="raw.html" class="raw-btn">ğŸ“„ æŸ¥çœ‹åŸå§‹å†…å®¹</a>
            </div>
            
            <div class="groups">
        '''
        
        # æ·»åŠ åˆ†ç»„å¡ç‰‡
        for group_name, group_channels in sorted(groups.items()):
            html += f'''
                <div class="group-card">
                    <div class="group-header">
                        {group_name} ({len(group_channels)}ä¸ªé¢‘é“)
                    </div>
                    <div class="channel-list">
            '''
            
            for channel in sorted(group_channels, key=lambda x: x['name']):
                html += f'''
                        <div class="channel-item">
                            <div class="channel-name">{channel["name"]}</div>
                            <a href="{channel["url"]}" class="play-btn" target="_blank">æ’­æ”¾</a>
                        </div>
                '''
            
            html += '''
                    </div>
                </div>
            '''
        
        # HTMLå°¾éƒ¨
        html += f'''
            </div>
            
            <div class="update-time">
                <p>æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</p>
                <p>ğŸ”§ æœ¬é¡µé¢ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ | æ¯å¤©è‡ªåŠ¨æ›´æ–°</p>
                <p>âš ï¸ é¢‘é“å†…å®¹æ¥æºäºç½‘ç»œï¼Œè¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„</p>
            </div>
            
            <script>
                // ä¸ºæ‰€æœ‰æ’­æ”¾æŒ‰é’®æ·»åŠ ç‚¹å‡»ç»Ÿè®¡
                document.querySelectorAll('.play-btn').forEach(btn => {{
                    btn.addEventListener('click', function(e) {{
                        const channelName = this.parentElement.querySelector('.channel-name').textContent;
                        console.log('æ’­æ”¾é¢‘é“:', channelName);
                        // è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡ä»£ç 
                    }});
                }});
                
                // è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼ˆæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
                setTimeout(() => {{
                    window.location.reload();
                }}, 5 * 60 * 1000);
            </script>
        </body>
        </html>
        '''
        
        # ä¿å­˜HTMLæ–‡ä»¶
        with open('index.html', 'w', encoding='utf-8') as f:
            f.write(html)
        
        # åˆ›å»ºåŸå§‹å†…å®¹é¡µé¢
        raw_html = f'''<!DOCTYPE html>
        <html>
        <head><meta charset="UTF-8"><title>åŸå§‹M3Uå†…å®¹</title></head>
        <body>
            <h1>åŸå§‹M3Uå†…å®¹</h1>
            <p><a href="index.html">è¿”å›ä¸»é¡µé¢</a></p>
            <pre>{content}</pre>
        </body>
        </html>
        '''
        
        with open('raw.html', 'w', encoding='utf-8') as f:
            f.write(raw_html)
        
        print(f"è§£æå®Œæˆ: {len(channels)}ä¸ªé¢‘é“, {len(groups)}ä¸ªåˆ†ç»„")
        EOF
        
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add index.html jackTV.m3u raw.html
        git commit -m "ğŸ“º æ›´æ–°é¢‘é“åˆ—è¡¨ $(date '+%Y-%m-%d %H:%M') - $(wc -l < jackTV.m3u)è¡Œ" || echo "No changes to commit"
        git push origin HEAD:${{ github.ref_name }}
